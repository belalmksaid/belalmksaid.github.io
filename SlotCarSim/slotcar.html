<html>
	<head>
	<title>Dynamics-Matlab Slot Car Simulation</title>
		<style type="text/css">
			html * {
	margin: 0px; 
	padding: 0px;
	font-family: "Calibri";
	font-weight: 100;
}

		</style>
		<script type="text/javascript" src="disquemath.js"></script>
		<script type="text/javascript" src="jquery.js"></script>
		<script>
		function sign(n) {
			if(isNaN(n)) return 0;
			return Math.sign(n);
		}
		function getParameterByName(name, url) {
    		if (!url) {
     			url = window.location.href;
    		}
    		name = name.replace(/[\[\]]/g, "\\$&");
    		var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
       		results = regex.exec(url);
    		if (!results) return null;
    		if (!results[2]) return '';
    		return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		function renderCircle(c, p, r) {
			c.beginPath();
    		c.arc(p.x, p.y, r, 0, 2 * Math.PI);
    		c.closePath();
    		c.strokeStyle = '#000000';
    		c.stroke();
		}
		function renderRectangle(c, p, w, h, o) {
			var mw = w / 2.0;
			var mh = h / 2.0;
			c.save();
			c.translate(p.x, p.y);
			c.rotate(o);
			c.translate(-p.x, -p.y);
    		c.rect(p.x - mw, p.y - mh, w, h);
    		c.lineWidth = 0.5;
    		c.strokeStyle = '#000000';
    		c.stroke();
    		c.restore();
		}
		function car(p) {
			this.position = p;
			this.angle = 0;
			this.move = function(h) {
				this.angle = Math.atan2(h.y - this.position.y, h.x - this.position.x);
				this.position = h;
			}
			this.draw = function(c) {
				//renderCircle(c, this.position, 5);
				renderRectangle(c, this.position, 3 * 150 / 33.7493, 1.25 * 150 / 33.7493, this.angle);
			}
		}
		function drawTrack(x, y, c) {
			n = x.length;
			c.save();
			for(var i = 1; i < n; i++) {
				c.beginPath();
      			c.moveTo((x[i - 1] ) * d + w / 2.0, (y[i - 1]) * d + h / 2.0);
      			c.lineTo((x[i]) * d + w / 2.0, (y[i]) * d + h / 2.0);
      			c.lineWidth = 1;
      			c.strokeStyle = '#ff0000';
      			c.stroke();
			}
			c.restore();
		}
		function cleanArray(actual) {
  			var newArray = new Array();
  			for (var i = 0; i < actual.length; i++) {
    		if (actual[i]) {
      			newArray.push(actual[i]);
    		}
  		}		
 		return newArray;
		}
		function drawLegend(c) {
			c.font = "15px Calibri"
  			c.save();
    		c.rect(20, 499, 160, 100);
    		c.lineWidth = 2;
    		c.strokeStyle = '#000000';
    		c.stroke();
  			c.restore();
  			renderRectangle(c, v(40, 515), 30, 18, 0);
  			c.fillText('Car', 80, 520);
  			c.fillText('Normal Force', 80, 589);
  			c.save();
			c.beginPath();
			c.setLineDash([1, 2]);
			c.moveTo(24, 543);
			c.lineTo(56, 543);
			c.fillText('Radius', 80, 547);
			c.stroke();
			c.restore();
			c.save();
			c.beginPath();
      		c.moveTo(24, 563);
			c.lineTo(56, 563);
			c.fillText('Track', 80, 569);
      		c.lineWidth = 1;
      		c.strokeStyle = '#ff0000';
      		c.stroke();
      		c.restore();
      		c.save();
			c.beginPath();
      		c.moveTo(24, 584);
			c.lineTo(56, 584);
      		c.lineWidth = 1;
      		c.strokeStyle = '#0000ff';
      		c.stroke();
      		c.restore();

  		}
		var track;
		var x = new Array(), y = new Array(), temp;
		var file = getParameterByName("t");
		var loaded = false;
		</script>
	</head>
	<body>
	<table>
		<tr>
			<td><canvas id="board" height="600" width="800"></canvas></td>
			<td>
			<div style="height: 600px; width: 200px;">

			<fieldset>
                <legend>Display Options</legend>
                        <input type="checkbox" id="showradius" checked="true" />Show Radius<br />
                        <input type="checkbox" id="shownforce" checked="true" />Show Normal Force<br />
                        <input type="checkbox" id="freeze"/>Freeze<br />
        </fieldset>
        <br/>
              <p id="vel_label" label="Velocity:" unit="m/s">Velocity: 0 m/s</p>
              <br/>
              <p id="norm_label" label="Normal Force:" unit="N">Normal Force: 0 N</p>
              <br/>
              <p id="mass_label" label="Mass:" unit="kg">Mass: 0 kg</p>
			</div>
			
			</td>

		</tr>
	</table>
		
		<input type="range" id="t_position" value="0" style="width: 800px; clear: left; " />
		<script type="text/javascript">
			c = board.getContext('2d');
			w = board.width;
			h = board.height;
			d = 150.0;
			mass = 0.019;
			drawLegend(c);
			var vel = 130.4;
			$.get(file, function(data) {
      		track = data.split('|');
      		track = cleanArray(track);	
  		n = track.length;
  		for(var i = 0; i < n; i++) {
  			temp = track[i].split(",");
  			x[i] = parseFloat(temp[0]);
  			y[i] = parseFloat(temp[1]);
  		}
  		loaded = true;
  		$(document).ready(function() {
				drawTrack(x, y, c);
				var cart = new car(v(x[0] * d + w / 2.0, y[0] * d + h / 2.0));
				cart.draw(c);
				var t = 1;
				setInterval(function() {
					if(!freeze.checked) {
				c.clearRect(0, 0, board.width, board.height);
				drawTrack(x, y, c);
				drawLegend(c);
				var tpoint = v(x[t] * d + w / 2.0, y[t] * d + h / 2.0);
				var target = (tpoint).subt(cart.position);
				target.normalize();
				var tt = t == 0 ? n - 1 : t - 1;
				var tk1 = t == (n - 1) ? 0 : t + 1;
				var tm1 = v(x[tt] * d + w / 2.0, y[tt] * d + h / 2.0);
				var tp1 = v(x[tk1] * d + w / 2.0, y[tk1] * d + h / 2.0);
				var s1 = (tpoint.y - tm1.y) / (tpoint.x - tm1.x);
				var s2 = (tp1.y - tpoint.y) / (tp1.x - tpoint.x);
				var ss = (s2 - s1) / ((tp1.x - tm1.x) / 2.0);
				//var s1 = v((tpoint.x - tm1.x), (tpoint.y - tm1.y));
				//var s2 = v((tp1.x - tpoint.x), (tp1.y - tpoint.y));
				var radiusCurv = Math.abs(Math.pow(1 + Math.pow((s1 + s2) / 2.0, 2), (3/2)) / ss);
				var alt = (tpoint).subt(tm1);
				var radc = alt.clone().normalize();
				var temp = radc.x;
				radc.x = radc.y;
				radc.y = -temp;
				var midpt = (cart.position).add(tm1).scale(0.5);
				var endpt = midpt.add(radc.scale(Math.abs(radiusCurv * sign(radiusCurv)) * sign(ss) * sign(-1 * y[t])));
				var norm = midpt.add(radc.scale(0.019 * Math.pow(vel, 2) / radiusCurv * sign(ss) * sign(y[t])));
				if(showradius.checked) {
					c.save();
					c.beginPath();
					c.setLineDash([1, 2]);
					c.moveTo(midpt.x,midpt.y);
					c.lineTo(endpt.x,endpt.y);
					c.stroke();
					c.restore();
				}
				if(shownforce.checked) {
					c.save();
					c.beginPath();
    				c.strokeStyle = '#0000FF';
					c.moveTo(midpt.x,midpt.y);
					c.lineTo(norm.x,norm.y);
					c.stroke();
					c.restore();
				}
				var dot = (target.x * alt.x + target.y * alt.y) / (target.length() * alt.length());
				var angle = Math.acos(dot) * 180 / (Math.PI);
				if(angle >= 15 || isNaN(angle)) 
					t++;
				else {
					target = target.scale(vel / 100.0);
					target = cart.position.add(target);
					cart.move(target);
				}
				if(t == (n - 1)) {
					cart.position = v(x[0] * d + w / 2.0, y[0] * d + h / 2.0);
					cart.angle = 0;
					t = 0;
				}
				t_position.value = t / (x.length) * 100;
				var nforce = Math.pow(vel, 2) / radiusCurv;
				vel_label.innerText = vel_label.getAttribute("label") + " " + vel + " " + vel_label.getAttribute("unit");
				norm_label.innerText = norm_label.getAttribute("label") + " " + (isNaN(nforce) ? 0 : nforce.toFixed(5)) + " " + norm_label.getAttribute("unit");
				mass_label.innerText = mass_label.getAttribute("label") + " " + mass + " " + mass_label.getAttribute("unit");
				cart.draw(c);
			}
		}, 0);
			});
  		});			
		</script>
	</body>
</html>